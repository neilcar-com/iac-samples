pipeline {
    agent any
    stages {
        stage('Add malware to custom feeds') {

            steps {
                withCredentials([usernamePassword(credentialsId: 'twistlock_creds', passwordVariable: 'TL_PASS', usernameVariable: 'TL_USER')]) {
                    
{% if twistlock_version.split('.')[0] == "18" %}
sh 'curl -s -k -u $TL_USER:$TL_PASS https://$TL_CONSOLE/api/v1/feeds/malware -X PUT -H "Content-Type:application/json" --data-binary @"evil-malware.json"'
{% else %}
sh 'curl -s -k -u $TL_USER:$TL_PASS https://$TL_CONSOLE/api/v1/feeds/custom/malware -X PUT -H "Content-Type:application/json" --data-binary @"evil-malware.json"'
{% endif %}
                }

            }
        }

        stage('Download malware in container') {
            agent {
                docker { image 'busybox' }
            }
            steps {
                sh 'rm evil | true'
                sh 'wget https://cdn.twistlock.com/john/evil'
            }
        }
    }

}
